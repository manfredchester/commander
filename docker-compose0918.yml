version: '3.1'
services:
    etcd:
     image: registry.connextpaas.com/library/etcd:v3.3
     volumes:
       - /data/etcd-data:/etcd-data
     ports:
       - 127.0.0.1:2280:2280
       - 2279:2279
     command: /usr/local/bin/etcd --data-dir=/etcd-data --name node1 --initial-advertise-peer-urls http://127.0.0.1:2280 --listen-peer-urls http://0.0.0.0:2280 --advertise-client-urls http://127.0.0.1:2279 --listen-client-urls http://0.0.0.0:2279 --initial-cluster node1=http://127.0.0.1:2280

    myadmin:
      image: registry.connextpaas.com/library/phpmyadmin:v0.1
      ports:
       - 53306:80
      links:
        - mysql
      environment:
        PMA_ARBITRARY: 1

    consul:
     image: registry.connextpaas.com/connextpaas/consul:1.4.4
     ports: 
       - 8500:8500
       - 8301:8301
       - 8300:8300
     volumes:
       - /data/consul/data:/consul/data
     links:
       - mysql
       - openldap
       - myadmin
     command: /bin/consul agent -server -bootstrap -data-dir=/consul/data  -node=server1 -ui -client=0.0.0.0


    openldap:
     image: registry.connextpaas.com/library/openldap:1.1.11
     ports: 
       - 389:389
     volumes: 
       - /data/slapd/database:/var/lib/ldap
       - /data/slapd/config:/etc/ldap/slapd.d
     environment:
       LDAP_DOMAIN: "connextpaas.com"
       LDAP_BASE_DN: "connextpaas.com"
       LDAP_ADMIN_PASSWORD: Connext@0101
    
    phpldapadmin:
     image: registry.connextpaas.com/library/phpldapadmin:0.7.1
     ports: 
       - 8001:80
     environment: 
       PHPLDAPADMIN_LDAP_HOSTS: "openldap"
       PHPLDAPADMIN_HTTPS: "false"
     links: 
       - openldap

    gateway: 
     image: registry.connextpaas.com/connextpaas/gateway:2.8.4.2
     links:
       - mysql
       - consul
     ports: 
       - 8080:8080
     command: >
        sh -c "sleep 20 && /entrypoint.sh /gateway"
     environment:
       CONSUL_ADDR: "http://consul:8500"
       CONSUL_HTTP_ADDR: "http://consul:8500"
     depends_on:
       - consul
     healthcheck:
       test: curl  http://consul:8500/v1/kv/micro/config/cache
       interval: 5s
       timeout: 5s
       retries: 2
     restart: on-failure:5 
       
    userservice:
     image: registry.connextpaas.com/connextpaas/userservice:2.8.4.2
     links:
       - mysql
       - consul
     environment:
       CONSUL_ADDR: "http://consul:8500"
       CONSUL_HTTP_ADDR: "http://consul:8500"
     depends_on:
       - consul
     healthcheck:
       test: curl  http://consul:8500/v1/kv/micro/config/cache
       interval: 5s
       timeout: 5s
       retries: 2
     restart: on-failure:5

           


    nginx:
      image: registry.connextpaas.com/connextpaas/connextvue:2.8.4.3
      ports:
       - 8002:8002
      network_mode: "host"
      
      volumes:
       - ./static:/static
       - ./static/header-logo.868df39a.png:/data/dist/img/header-logo.868df39a.png
       - ./static/login-logo.d967e918.svg:/data/dist/img/login-logo.d967e918.svg
     
    fileserver:
     image: registry.connextpaas.com/connextpaas/fileserver:2.8.4.2
     volumes:
       - /static:/static
     links:
       - consul
     ports:
       - 9998:8080
     environment:
       CONSUL_ADDR: "http://consul:8500"
       CONSUL_HTTP_ADDR: "http://consul:8500"
     depends_on:
       - consul
     healthcheck:
       test: curl  http://consul:8500/v1/kv/micro/config/cache
       interval: 5s
       timeout: 5s
       retries: 2
     restart: on-failure:5

    api-service-platform:
     image: registry.connextpaas.com/connextpaas/api-service-platform:20191016-8bf16bfb
     links:
      - mysql
      - consul
     environment:
      CONSUL_ADDR: "http://consul:8500"
      CONSUL_HTTP_ADDR: "http://consul:8500"
     depends_on:
      - consul
     healthcheck:
      test: curl  http://consul:8500/v1/kv/micro/config/cache
      interval: 5s
      timeout: 5s
      retries: 2
     restart: on-failure:5

     
    redis:
     image: registry.connextpaas.com/connextpaas/superset_redis:2.8.4
     restart: unless-stopped
     ports:
       - 6380:6380
     volumes:
       - /data/superset/redis/_data:/data

    postgres:
     image: registry.connextpaas.com/connextpaas/superset_postgres:2.8.4
     restart: unless-stopped
     environment:
      POSTGRES_DB: superset
      POSTGRES_PASSWORD: superset
      POSTGRES_USER: superset
     ports:
       - 5432:5432
     volumes:
       - /data/superset/postgres/_data:/var/lib/postgresql/data

    superset:
     image: registry.connextpaas.com/connextpaas/superset:2.8.4
     restart: unless-stopped
     environment:
      POSTGRES_DB: superset
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: superset
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6380
      SUPERSET_ENV: production
     ports:
       - 8088:8088
     depends_on:
       - postgres
       - redis
     volumes:
       - /data/superset/superset_config.py:/home/superset/superset/superset_config.py

    pd0:
     image: pingcap/pd:latest
     ports:
      - "2379"
     volumes:
      - ./tidb/config/pd.toml:/pd.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --name=pd0
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd0:2379
      - --advertise-peer-urls=http://pd0:2380
      - --initial-cluster=pd0=http://pd0:2380,pd1=http://pd1:2380,pd2=http://pd2:2380
      - --data-dir=/data/pd0
      - --config=/pd.toml
      - --log-file=/logs/pd0.log
     restart: on-failure
    pd1:
     image: pingcap/pd:latest
     ports:
      - "2379"
     volumes:
      - ./tidb/config/pd.toml:/pd.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --name=pd1
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd1:2379
      - --advertise-peer-urls=http://pd1:2380
      - --initial-cluster=pd0=http://pd0:2380,pd1=http://pd1:2380,pd2=http://pd2:2380
      - --data-dir=/data/pd1
      - --config=/pd.toml
      - --log-file=/logs/pd1.log
     restart: on-failure
    pd2:
     image: pingcap/pd:latest
     ports:
      - "2379"
     volumes:
      - ./tidb/config/pd.toml:/pd.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --name=pd2
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd2:2379
      - --advertise-peer-urls=http://pd2:2380
      - --initial-cluster=pd0=http://pd0:2380,pd1=http://pd1:2380,pd2=http://pd2:2380
      - --data-dir=/data/pd2
      - --config=/pd.toml
      - --log-file=/logs/pd2.log
     restart: on-failure
    tikv0:
     image: pingcap/tikv:latest
     volumes:
      - ./tidb/config/tikv.toml:/tikv.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv0:20160
      - --data-dir=/data/tikv0
      - --pd=pd0:2379,pd1:2379,pd2:2379
      - --config=/tikv.toml
      - --log-file=/logs/tikv0.log
     depends_on:
      - "pd0"
      - "pd1"
      - "pd2"
     restart: on-failure
    tikv1:
     image: pingcap/tikv:latest
     volumes:
      - ./tidb/config/tikv.toml:/tikv.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv1:20160
      - --data-dir=/data/tikv1
      - --pd=pd0:2379,pd1:2379,pd2:2379
      - --config=/tikv.toml
      - --log-file=/logs/tikv1.log
     depends_on:
      - "pd0"
      - "pd1"
      - "pd2"
     restart: on-failure
    tikv2:
     image: pingcap/tikv:latest
     volumes:
      - ./tidb/config/tikv.toml:/tikv.toml:ro
      - ./tidb/data:/data
      - ./tidb/logs:/logs
     command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv2:20160
      - --data-dir=/data/tikv2
      - --pd=pd0:2379,pd1:2379,pd2:2379
      - --config=/tikv.toml
      - --log-file=/logs/tikv2.log
     depends_on:
      - "pd0"
      - "pd1"
      - "pd2"
     restart: on-failure

    mysql:
     image: pingcap/tidb:latest
     ports:
      - "3306:4000"
      - "4000:4000"
      - "10080:10080"
     volumes:
      - ./tidb/config/tidb.toml:/tidb.toml:ro
      - ./tidb/logs:/logs
     command:
      - --store=tikv
      - --path=pd0:2379,pd1:2379,pd2:2379
      - --config=/tidb.toml
      - --log-file=/logs/tidb.log
     depends_on:
      - "tikv0"
      - "tikv1"
      - "tikv2"
     restart: on-failure
    tispark-master:
     image: pingcap/tispark:latest
     command:
      - /opt/spark/sbin/start-master.sh
     volumes:
      - ./tidb/config/spark-defaults.conf:/opt/spark/conf/spark-defaults.conf:ro
     environment:
      SPARK_MASTER_PORT: 7077
      SPARK_MASTER_WEBUI_PORT: 8080
     ports:
      - "7077:7077"
      - "58080:8080"
     depends_on:
      - "tikv0"
      - "tikv1"
      - "tikv2"
     restart: on-failure
    tispark-slave0:
     image: pingcap/tispark:latest
     command:
      - /opt/spark/sbin/start-slave.sh
      - spark://tispark-master:7077
     volumes:
      - ./tidb/config/spark-defaults.conf:/opt/spark/conf/spark-defaults.conf:ro
     environment:
      SPARK_WORKER_WEBUI_PORT: 38081
     ports:
      - "38081:38081"
     depends_on:
      - tispark-master
     restart: on-failure

    tidb-vision:
     image: pingcap/tidb-vision:latest
     environment:
      PD_ENDPOINT: pd0:2379
     ports:
      - "8010:8010"
     restart: on-failure


    pushgateway:
     image: prom/pushgateway:v0.3.1
     command:
      - --log.level=error
     restart: on-failure
    prometheus:
     user: root
     image: prom/prometheus:v2.2.1
     command:
      - --log.level=error
      - --storage.tsdb.path=/data/prometheus
      - --config.file=/etc/prometheus/prometheus.yml
     ports:
      - "9090:9090"
     volumes:
      - ./tidb/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./tidb/config/pd.rules.yml:/etc/prometheus/pd.rules.yml:ro
      - ./tidb/config/tikv.rules.yml:/etc/prometheus/tikv.rules.yml:ro
      - ./tidb/config/tidb.rules.yml:/etc/prometheus/tidb.rules.yml:ro
      - ./tidb/data:/data
     restart: on-failure
    grafana:
     image: grafana/grafana:6.0.1
     user: "0"
     environment:
      GF_LOG_LEVEL: error
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_PATHS_CONFIG: /etc/grafana/grafana.ini
     volumes:
      - ./tidb/config/grafana:/etc/grafana
      - ./tidb/config/dashboards:/tmp/dashboards
      - ./tidb/data/grafana:/var/lib/grafana
     ports:
      - "3000:3000"
     restart: on-failure
 
